package client

import (
	"encoding/json"
	"errors"
	"go-malwarebazaar/api"
	"net/url"
)

func (b *Bazaar) AddComment(hash string, comment string) error {
	if len(hash) != 64 {
		return errors.New("the hash must be SHA-256")
	}

	data := url.Values{
		"query":       {api.AddComment},
		"sha256_hash": {hash},
		"comment":     {comment},
	}

	var resp api.GenericResponse
	r, err := b.Client.Request(data)
	if err != nil {
		return err
	}

	if err = json.NewDecoder(r.Body).Decode(&resp); err != nil {
		return errors.New("failed to unmarshal the response body")
	}

	if resp.QueryStatus != "success" {
		if message, ok := api.ErrorTypes[resp.QueryStatus]; ok {
			return errors.New(message)
		}

		return errors.New("unknown error occurred")
	}

	return nil
}
