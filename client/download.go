package client

import (
	"bytes"
	"encoding/json"
	"errors"
	"github.com/alexmullins/zip"
	"go-malwarebazaar/api"
	"io"
	"io/ioutil"
	"net/url"
	"os"
)

const (
	ZipPassword = "infected"
)

func (b *Bazaar) DownloadFile(hash string, location string) (err error) {
	if len(hash) != 64 {
		return errors.New("the hash must be SHA-256")
	}

	data := url.Values{
		"query":       {api.DownloadFile},
		"sha256_hash": {hash},
	}

	r, err := b.Client.Request(data)
	if err != nil {
		return err
	}

	hashData, err := ioutil.ReadAll(r.Body)
	if err != nil {
		return err
	}

	if r.Header.Get("Content-Type") == "application/json" {
		var resp api.GenericResponse
		if err = json.NewDecoder(r.Body).Decode(&resp); err == nil {
			if message, ok := api.ErrorTypes[resp.QueryStatus]; ok {
				return errors.New(message)
			}

			return errors.New("unknown error occurred")
		}
	}

	if r.Header.Get("Content-Type") != "application/zip" {
		return errors.New("invalid content-type returned, failed to recognise header")
	}

	reader := bytes.NewReader(hashData)
	archive, err := zip.NewReader(reader, int64(len(hashData)))
	if err != nil {
		return err
	}

	if len(archive.File) != 1 {
		return errors.New("the file does not exist within the archive")
	}

	if zipFile := archive.File[0]; zipFile.IsEncrypted() {
		zipFile.SetPassword(ZipPassword)

		f, err := zipFile.Open()
		if err != nil {
			return err
		}

		defer f.Close()

		outFile, err := os.Create(location)
		if err != nil {
			return err
		}

		defer outFile.Close()

		if _, err = io.Copy(outFile, f); err != nil {
			return err
		}
	}

	return nil
}
